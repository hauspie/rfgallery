/*!
 * YoxView Flickr plugin
 * http://yoxigen.com/yoxview/
 *
 * Copyright (c) 2010 Yossi Kolesnicov
 *
 * Licensed under the MIT license.
 * http://www.opensource.org/licenses/mit-license.php
 *
 * Date: 1st April, 2010
 * Version : 1.2
 */ 
function yoxview_flickr(){function t(e,f,i,d){var a=e.data("yoxview").viewIndex,k=[];h.jsonp({url:p,async:false,data:i,dataType:"jsonp",callbackParameter:"jsoncallback",success:function(g){if(g.photosets&&g.photosets.photoset.length!=0){var m=h("<ul>",{className:"yoxview-thumbnails"});m.appendTo(e);jQuery.each(g.photosets.photoset,function(b,c){b=c.title?c.title._content:"Set";b+=" ("+c.photos+" images)";var l=q(c,n[i.thumbnailsMaxSize]),j=r+"photos/"+(i.user||i.user_id)+"/sets/"+c.id,o=h("<li>", {css:{width:"75px",height:"75px"}});createThumbnail(j,b,b,l,a).data("yoxview",{user:i.user,user_id:i.user_id,photoset_id:c.id}).appendTo(o);o.appendTo(m);o.yoxview(f,d)})}else if(g.photoset&&g.photoset.photo.length!=0&&f.setSinglePhotosetThumbnails){u(g,undefined,k,i.imagesSize,i.thumbnailsMaxSize);e.addClass("yoxview-thumbnails");if(f.setTitle){var s=h("<div>",{className:"yoxview-thumbnails-details"});h.jsonp({url:p,async:false,data:h.extend({},{method:"flickr.photosets.getInfo",photoset_id:f.photoset_id}, v),dataType:"jsonp",callbackParameter:"jsoncallback",success:function(b){b=b.photoset;s.append("<h2>"+b.title._content+"</h2>","By ","<a href='"+r+"photos/"+b.owner+"' title=\"Go to "+(f.user||"the user's")+"'s flickr page\" target='_blank'>"+f.user+"</a>","<div style='clear:both;'></div>").prependTo(e)}})}h.each(k,function(b,c){var l=createThumbnail(c.src,c.alt,c.title,c.thumbnailSrc);c.thumbnailImg=l.children("img:first");l.data("yoxview",{viewIndex:a,imageIndex:b}).bind("click.yoxview",function(){var j= h(this).data("yoxview");yoxviewApi.openGallery(j.viewIndex,j.imageIndex);return false}).appendTo(e)})}d.onLoadComplete&&d.onLoadComplete()},error:function(g,m){d.onLoadError&&d.onLoadError("Can't load data from flickr.")}});return k}function q(e,f){return"http://farm"+e.farm+".static.flickr.com/"+e.server+"/"+(e.primary||e.id)+"_"+e.secret+f+".jpg"}function u(e,f,i,d,a){jQuery.each(e.photoset.photo,function(k,g){k={thumbnailSrc:q(g,a?n[a]:n.smallSquare),src:q(g,d?n[d]:n.medium),title:g.title,alt:g.title, link:"",thumbnailImg:f?f.children("img:first"):null};i.push(k)})}var h=jQuery,r="http://www.flickr.com/",p="http://api.flickr.com/services/rest/",x=/\d+@N\d+/,v={api_key:"cd6c91f9721f34ead20e6ebe03dd5871",format:"json"};this.getImagesData=function(e,f,i,d){var a=jQuery.extend({},{imagesSize:"medium",thumbnailsMaxSize:"smallSquare",setThumbnail:true,setSinglePhotosetThumbnails:true,setTitle:true,method:"flickr.photosets.getList"},d.dataSourceOptions,v);a.media="photos";if(a.user&&a.photoset_id)a.method= "flickr.photosets.getPhotos";var k=screen.width>screen.height?screen.width:screen.height;if(!a.imagesSize||k.width<=800&&a.imagesSize!="medium")a.imagesSize="medium";var g=[],m=0,s=/http:\/\/(www.)?flickr.com\/photos\/([^\/]+)\/sets\/([^\?]+).*/;f.find("a:has(img)").each(function(){var b=h(this),c=this.href.match(s);if(c){c={user:c[2],photoset_id:c[3]};var l=b.data("yoxview");l?jQuery.extend(l,c):b.data("yoxview",c);var j=b.parent().data("yoxview");b.bind("click.yoxview",function(){var o=h(this).data("yoxview"); if(j.imagesAreSet)e.openGallery(b.parent().data("yoxview").viewIndex);else{b.css("cursor","wait");h.jsonp({url:p,data:jQuery.extend({},a,o,{method:"flickr.photosets.getPhotos",api_key:"cd6c91f9721f34ead20e6ebe03dd5871",format:"json",media:"photos"}),dataType:"jsonp",callbackParameter:"jsoncallback",success:function(y){var w=[];u(y,b,w,a.imagesSize,a.thumbnailsMaxSize);j.images=w;j.imagesAreSet=true;b.css("cursor","");e.openGallery(j.viewIndex)}})}return false});m++}});if(m==0){d.onLoadBegin&&d.onLoadBegin(); if(a.user&&a.user.match(x))a.user_id=a.user;if(!a.user_id&&a.user&&!a.photoset_id)h.jsonp({url:p,data:h.extend({},a,{username:a.user,method:"flickr.people.findByUsername"}),dataType:"jsonp",callbackParameter:"jsoncallback",success:function(b){if(!b.user&&d.onLoadError){d.onLoadError("User not found.");return false}a.user_id=b.user.nsid;if(a.setTitle){var c=h("<div>",{className:"yoxview-thumbnails-details"});b=b.user.username._content;c.append("<h2><a href='"+r+"photos/"+a.user_id+"' target='_blank' title=\"Go to "+ b+"'s gallery in flickr\">"+b+"</a>'s sets:</h2>","<div style='clear:both;'></div>").prependTo(f)}g=t(f,i,a,d)},error:function(b,c){d.onLoadError&&d.onLoadError("User not found. Have you tried using the NSID?")}});else g=t(f,a,a,d)}return g};var n={smallSquare:"_s",thumbnail:"_t",small:"_m",medium:"",large:"_b",original:"_o"}};