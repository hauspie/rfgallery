/*!
 * YoxView Picasa plugin
 * http://yoxigen.com/yoxview/
 *
 * Copyright (c) 2010 Yossi Kolesnicov
 *
 * Licensed under the MIT license.
 * http://www.opensource.org/licenses/mit-license.php
 *
 * Date: 1st March, 2010
 * Version : 1.2
 */ 
function yoxview_picasa(){function q(c){var e=c.url+c.user;if(c.album)e+="/album/"+c.album;e+="?imgmax="+c.imagesMaxSize+"&alt=json";if(c.thumbnailsMaxSize)e+="&thumbsize="+c.thumbnailsMaxSize;if(c.authkey)e+="&authkey="+c.authkey;return e}function p(c,e){for(var l=e.length;l>=0;l--){c=parseInt(c);var b=e[l];if(c>=b)return b}return c}function r(c,e,l){jQuery.each(c.feed.entry,function(b,a){b=a.summary.$t;a={thumbnailSrc:a.media$group.media$thumbnail[0].url,src:a.content.src,title:b,alt:b,link:a.link[1].href, thumbnailImg:e?e.children("img:first"):null};l.push(a)})}var i=jQuery;this.getImagesData=function(c,e,l,b){var a=jQuery.extend({},{url:"http://picasaweb.google.com/data/feed/api/user/",setThumbnail:true,setSingleAlbumThumbnails:true,setTitle:true},b.dataSourceOptions);if(a.album=="")a.album=null;if(a.imagesMaxSize)a.imagesMaxSize=p(a.imagesMaxSize,s);var n=screen.width>screen.height?screen.width:screen.height;if(!a.imagesMaxSize||n<a.imagesMaxSize)a.imagesMaxSize=p(n,s);if(a.thumbnailsMaxSize)a.thumbnailsMaxSize= p(a.thumbnailsMaxSize,w);n=q(a);var o=[],t=e.data("yoxview").viewIndex;if(a.album){b.onLoadBegin&&b.onLoadBegin();i.jsonp({url:n,async:false,dataType:"jsonp",callbackParameter:"callback",success:function(d){var f,j=d.feed,h=j.title.$t;if(!a.setSingleAlbumThumbnails&&a.setThumbnail){h=h+" ("+j.gphoto$numphotos.$t+" images)";f=createThumbnail(j.link[1].href,h,h,j.icon.$t,e.data("yoxview").viewIndex);f.bind("click.yoxview",function(){var g=i(this).data("yoxview");c.openGallery(g.viewIndex);return false}); f.appendTo(e);c.thumbnail=f}r(d,f,o);if(a.setSingleAlbumThumbnails&&o.length!=0){e.addClass("yoxview-thumbnails");if(a.setTitle){f=i("<div>",{className:"yoxview-thumbnails-details"});d=d.feed.author[0];f.append("<h2>"+h+"</h2>","By ","<a href='"+d.uri.$t+"' title=\"Go to "+d.name.$t+"'s Picasa page\" target='_blank'>"+d.name.$t+"</a>","<div style='clear:both;'></div>").prependTo(e)}i.each(o,function(g,k){var m=createThumbnail(k.src,k.alt,k.title,k.thumbnailSrc);k.thumbnailImg=m.children("img:first"); m.data("yoxview",{viewIndex:t,imageIndex:g}).bind("click.yoxview",function(){var u=i(this).data("yoxview");c.openGallery(u.viewIndex,u.imageIndex);return false}).appendTo(e)})}b.onLoadComplete&&b.onLoadComplete()},error:function(d,f){b.onLoadError&&b.onLoadError("Album '"+a.album+"' for user '"+a.user+"' not found.")}})}else{var v=0,x=/http:\/\/picasaweb.google.*\/([^\/]+)\/([^\?]+).*/;e.find("a:has(img)").each(function(){var d=i(this),f=this.href.match(x);if(f){f={user:f[1],album:f[2]};var j=d.data("yoxview"); j?jQuery.extend(j,f):d.data("yoxview",f);var h=d.parent().data("yoxview");d.bind("click.yoxview",function(){var g=i(this).data("yoxview");if(h.imagesAreSet)c.openGallery(d.parent().data("yoxview").viewIndex);else{d.css("cursor","wait");i.ajax({url:q(jQuery.extend(a,g)),dataType:"jsonp",success:function(k){var m=[];r(k,d,m);h.images=m;h.imagesAreSet=true;d.css("cursor","");c.openGallery(h.viewIndex)}})}return false});v++}});if(v==0){b.onLoadBegin&&b.onLoadBegin();i.jsonp({url:n,dataType:"jsonp",callbackParameter:"callback", success:function(d){if(d.feed.entry){if(a.setTitle){var f=d.feed.author[0];i("<div>",{className:"yoxview-thumbnails-details"}).append("<h2><a href='"+f.uri.$t+"' target='_blank' title=\"Go to "+f.name.$t+"'s gallery in Picasa\">"+f.name.$t+"</a>'s gallery</h2>","<div style='clear:both;'></div>").prependTo(e)}var j=i("<ul>",{className:"yoxview-thumbnails"});j.appendTo(e);jQuery.each(d.feed.entry,function(h,g){if(g.gphoto$numphotos.$t!="0"){h=g.title.$t+" ("+g.gphoto$numphotos.$t+" images)";var k=g.media$group.media$thumbnail[0].url, m=g.link[1].href;g=i("<li>",{css:{width:g.media$group.media$thumbnail[0].width,height:g.media$group.media$thumbnail[0].height}});createThumbnail(m,h,h,k,t).data("yoxview",{user:a.user,album:h}).appendTo(g);g.appendTo(j).yoxview(l,b)}});b.onLoadComplete&&b.onLoadComplete()}else b.onNoData&&b.onNoData()},error:function(d,f){b.onLoadError&&b.onLoadError("User '"+a.user+"' not found.")}})}}return o};var w=[32,48,64,72,104,144,150,160],s=[94,110,128,200,220,288,320,400,512,576,640,720,800,912,1024,1152, 1280,1440,1600]};